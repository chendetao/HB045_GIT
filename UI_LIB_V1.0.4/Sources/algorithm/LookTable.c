
#include "LookTable.h"

struct Node{
	float voltage;
	float level;
};

const struct Node looktable[] = {
{4.153600,100.0},
{4.153500,99.27},
{4.143400,98.54},
{4.133100,97.08},
{4.124800,96.35},
{4.116100,95.62},
{4.107700,94.89},
{4.099000,94.16},
{4.091000,92.70},
{4.074500,91.24},
{4.066200,90.51},
{4.058400,89.78},
{4.050700,88.32},
{4.042900,87.59},
{4.034900,86.86},
{4.026800,86.13},
{4.011600,83.94},
{4.005100,83.21},
{3.999200,82.48},
{3.991800,81.75},
{3.983100,81.02},
{3.973200,79.56},
{3.963900,78.83},
{3.947400,77.37},
{3.940000,76.64},
{3.933200,75.18},
{3.927000,74.45},
{3.921700,73.72},
{3.917400,72.99},
{3.913000,72.26},
{3.901900,70.07},
{3.895700,69.34},
{3.889500,68.61},
{3.883600,67.88},
{3.877400,66.42},
{3.871800,65.69},
{3.865600,64.96},
{3.854400,63.50},
{3.848500,62.04},
{3.843000,61.31},
{3.836800,60.58},
{3.830200,59.85},
{3.823700,59.12},
{3.817500,57.66},
{3.806400,56.20},
{3.801700,55.47},
{3.796800,54.74},
{3.792400,53.28},
{3.789000,52.55},
{3.785300,51.82},
{3.781900,51.09},
{3.778200,50.36},
{3.770700,48.18},
{3.767600,47.45},
{3.764200,46.72},
{3.760800,45.99},
{3.758000,44.53},
{3.754900,43.80},
{3.752100,43.07},
{3.746800,41.61},
{3.743700,40.15},
{3.741300,39.42},
{3.738500,38.69},
{3.736000,37.96},
{3.733800,37.23},
{3.731300,35.77},
{3.726700,34.31},
{3.724500,33.58},
{3.722400,32.85},
{3.720500,31.39},
{3.718300,30.66},
{3.715800,29.93},
{3.713400,29.20},
{3.707200,27.01},
{3.704400,26.28},
{3.701300,25.55},
{3.698200,24.82},
{3.694800,24.09},
{3.691700,22.63},
{3.688900,21.90},
{3.683000,20.44},
{3.680200,19.71},
{3.677100,18.25},
{3.673100,17.52},
{3.668700,16.79},
{3.664100,16.06},
{3.659700,15.33},
{3.650100,13.14},
{3.643300,12.41},
{3.636500,11.68},
{3.632500,10.95},
{3.629700,9.49},
{3.625900,8.76},
{3.624100,8.03},
{3.613500,6.57},
{3.601500,5.11},
{3.579400,4.38},
{3.546600,3.65},
{3.505000,2.92},
{3.451700,2.19},
{3.382300,0.05},
{3.282300,0.01},
{3.182300,0.00},
};

/** 
 * 二分查找法，找到对应ADC值的数组下标 
 * 注意：原数据为逆序存放，经典二分查找算法要修改一下。
 */
static int get_index(float voltage)
{
	float min = voltage-looktable[0].voltage;
	if ( min < 0 ) min *= -1;
	
	int idx = 0;
	
	for ( int i = 0; i < (sizeof(looktable)/sizeof(looktable[0])); i++ )
	{
		float temp = voltage-looktable[i].voltage;
		if ( temp < 0 ) temp *= -1;
		if ( min > temp )
		{
			min = temp;
			idx = i;
		}
	}
    
    /* 若没有查找到，则返回最临近的 */
    return idx;
}

/**
 * 根据下标在温度值数组中取得对应温度值。
 */
static float getTvalue(int index)
{ 
  return looktable[index].level;
}
   

/**
* 外部调用接口
*/
float getBattery(float voltage)
{
    int idx;
    
    idx = get_index( voltage );
    
    return getTvalue(idx);
}
